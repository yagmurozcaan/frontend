<!--
Video Recording Page for NEUROLOOK Project
Interactive autism detection test with camera recording, eye tracking, and sequential games.
Features MediaPipe face detection, speech synthesis, and real-time video processing with game-based data collection.
-->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Otizm Testi - Oyun Kaydı</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(79,172,254,0.25), transparent),
                radial-gradient(1000px 500px at 90% 20%, rgba(0,242,254,0.25), transparent),
                linear-gradient(135deg, #0b1220, #0a0f1a);
    color: #e5e7eb;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 40px 24px;
    overflow: hidden;
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: radial-gradient(#00f2fe 1px, transparent 0),
                      radial-gradient(#4facfe 1px, transparent 0);
    background-size: 40px 40px, 40px 40px;
    background-position: 0 0, 20px 20px;
    opacity: 0.15;
    z-index: -1;
    animation: moveDots 60s linear infinite;
}
@keyframes moveDots { from {background-position:0 0,20px 20px;} to {background-position:400px 400px,420px 420px;} }

.card {
    background: rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.12);
    border-radius:16px;
    backdrop-filter: blur(12px);
    box-shadow:0 20px 50px rgba(0,0,0,0.35);
    padding:20px;
    width:400px;
    text-align:center;
    transition: all 0.5s ease-in-out;
}
.card.shrink {
    position: fixed;
    bottom:20px;
    right:20px;
    width:280px;
    padding:10px;
}
video { width:100%; border-radius:12px; border:1px solid rgba(255,255,255,0.2); margin-bottom:10px; }

.btn { padding:10px 20px; margin:5px; border:none; border-radius:10px; cursor:pointer; font-weight:800; letter-spacing:0.2px; transition: all 0.2s ease; }
.start { background: linear-gradient(135deg, #22c55e, #86efac); color: #0b1220; }
.stop { background: linear-gradient(135deg, #ef4444, #fca5a5); color: #0b1220; }
.stop:disabled, .start:disabled { opacity:0.6; cursor:not-allowed; }

#gameArea {
    width:1200px; height:600px;
    border:1px solid rgba(255,255,255,0.12);
    margin-left:20px;
    position:relative;
    background: rgba(255,255,255,0.04);
    border-radius:12px;
    overflow:hidden;
    display:flex; justify-content:center; align-items:center;
    font-size:48px; font-weight:bold; color:#e5e7eb;
}
#target { position:absolute; width:50px; height:50px; background: radial-gradient(circle at 30% 30%, #fb7185, #ef4444); box-shadow:0 10px 20px rgba(239,68,68,0.35); border-radius:50%; display:none; }
#faceVideo {
    position: absolute;
    display: none;
    height: 100%;
    width: auto;
    max-width: 100%;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    object-fit: contain;
}

#waveGif {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    display:none;
    max-width:40%;
    max-height:60%;
    object-fit:contain;
    animation: fadeInOut 5s ease-in-out;
}
@keyframes fadeInOut {
  0% {opacity:0; transform:translate(-50%,-50%) scale(0.9);}
  10%,90% {opacity:1; transform:translate(-50%,-50%) scale(1);}
  100% {opacity:0; transform:translate(-50%,-50%) scale(1.1);}
}

#loadingText {
    display:none;
    position:absolute;
    font-size:24px;
    font-weight:800;
    color:#e5e7eb;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
}
</style>
</head>
<body>

<div class="card" id="recordCard">
    <h3>{{ isim }} {{ soyisim }}</h3>
    <video id="preview" autoplay playsinline muted></video>
    <div>
        <button id="startBtn" class="btn start">Kaydı Başlat</button>
        <button id="stopBtn" class="btn stop" disabled>Kaydı Durdur</button>
    </div>
</div>

<div id="gameArea">
    <div id="target"></div>
    <video id="faceVideo" autoplay muted></video>

    <img id="waveGif" src="/static/el-sallama.gif" alt="El sallama">

    <div id="loadingText">Yükleniyor, lütfen bekleyin...</div>
</div>

<script>
let mediaRecorder; let recordedChunks=[];
const video=document.getElementById('preview');
const startBtn=document.getElementById('startBtn');
const stopBtn=document.getElementById('stopBtn');
const card=document.getElementById('recordCard');
const gameArea=document.getElementById('gameArea');
const target=document.getElementById('target');
const faceVideo=document.getElementById('faceVideo');
const waveGif=document.getElementById('waveGif');
const loadingText=document.getElementById('loadingText');

navigator.mediaDevices.getUserMedia({video:true,audio:false})
.then(stream=>{
    video.srcObject=stream;
    mediaRecorder=new MediaRecorder(stream);
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);}
    mediaRecorder.onstop=()=>{
        loadingText.style.display='block';
        const blob=new Blob(recordedChunks,{type:'video/webm'});
        recordedChunks=[];
        const formData=new FormData();
        formData.append('video',blob,'{{ isim }}_{{ soyisim }}.webm');
        formData.append('isim','{{ isim }}');
        formData.append('soyisim','{{ soyisim }}');
        fetch('/upload',{method:'POST',body:formData})
        .then(resp=>{
            loadingText.style.display='none';
            if(resp.ok) window.location.href="/finish";
            else alert("Video yüklenirken hata oluştu.");
        });
        card.classList.remove('shrink'); clearAllIntervals();
    };
})
.catch(err=>alert("Kamera açılamadı: "+err));

startBtn.onclick=()=>{
    mediaRecorder.start();
    startBtn.disabled=true; stopBtn.disabled=false;
    card.classList.add('shrink');
    startSequentialGames();
    startEyeTracking();
};
stopBtn.onclick=()=>{
    if(mediaRecorder.state!=="inactive") mediaRecorder.stop();
    startBtn.disabled=false; stopBtn.disabled=true;
    clearAllIntervals();
};

let intervals=[]; let timeouts=[];
function clearAllIntervals(){
    intervals.forEach(i=>clearInterval(i));
    intervals=[]; timeouts.forEach(t=>clearTimeout(t));
    timeouts=[];
    target.style.display='none';
    faceVideo.style.display='none';
    waveGif.style.display='none';
}

function randomTarget(){
    const x=Math.random()*(gameArea.clientWidth-50);
    const y=Math.random()*(gameArea.clientHeight-50);
    target.style.left=x+'px'; target.style.top=y+'px'; target.style.display='block';
    new Audio('/static/pop.mp3').play();
}

function showFaceVideo(){
    faceVideo.src='/static/mutlu_video.mp4';
    faceVideo.style.display='block';
    faceVideo.play();
    faceVideo.onloadedmetadata=()=>{
        setTimeout(()=>{
            faceVideo.pause();
            faceVideo.style.display='none';
            if(mediaRecorder.state!=="inactive") mediaRecorder.stop();
        }, faceVideo.duration*1000);
    };
    new Audio('/static/sound.mp3').play();
}

function showNameCall(){
    waveGif.style.display='block';
    const msg=new SpeechSynthesisUtterance(`Merhaba {{ isim }}!`);
    window.speechSynthesis.speak(msg);
    setTimeout(()=>{waveGif.style.display='none';},5000);
}

function startSequentialGames(){
    clearAllIntervals(); let step=0;
    function nextStep(){
        step++;
        if(step==1){
            intervals.push(setInterval(randomTarget,1000));
            timeouts.push(setTimeout(()=>{clearAllIntervals(); nextStep();},12000));
        } else if(step==2){
            timeouts.push(setTimeout(()=>{
                showNameCall();
                timeouts.push(setTimeout(()=>{nextStep();},5000));
            },1000+Math.random()*5000));
        } else if(step==3){
            timeouts.push(setTimeout(()=>{showFaceVideo();},1000));
        }
    }
    nextStep();
}

function startEyeTracking(){
    const videoElement=document.getElementById('preview');
    let alertTriggered=false; let alertStartTime=null;
    const ALERT_SECONDS=3; const EYE_AR_THRESHOLD=0.25;
    const faceMesh=new FaceMesh({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
    faceMesh.onResults(results=>{
        let alertCondition=false;
        if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
            const l=results.multiFaceLandmarks[0];
            function eyeAspectRatio(indices){
                function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
                const hor=dist(l[indices[0]],l[indices[3]]);
                const ver=(dist(l[indices[1]],l[indices[5]])+dist(l[indices[2]],l[indices[4]]))/2;
                return ver/hor;
            }
            const LEFT_EYE=[33,160,158,133,153,144];
            const RIGHT_EYE=[362,385,387,263,373,380];
            const ear=(eyeAspectRatio(LEFT_EYE)+eyeAspectRatio(RIGHT_EYE))/2;
            if(ear<EYE_AR_THRESHOLD) alertCondition=true;
        } else {alertCondition=true;}

        if(alertCondition){
            if(!alertStartTime) alertStartTime=Date.now();
            else if(Date.now()-alertStartTime>ALERT_SECONDS*1000 && !alertTriggered){
                alertTriggered=true;
                const msg=new SpeechSynthesisUtterance(`Hadi ekrana bakalım, {{ isim }}!`);
                window.speechSynthesis.speak(msg);
            }
        } else {
            alertStartTime=null;
            alertTriggered=false;
        }
    });
    const camera=new Camera(videoElement,{onFrame:async()=>{await faceMesh.send({image:videoElement});}, width:640,height:480});
    camera.start();
}
</script>
</body>
</html>
