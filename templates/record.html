<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Otizm Testi - Oyun Kaydı</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding-top:50px;
}
.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 20px;
    width: 400px;
    text-align: center;
    transition: all 0.5s ease-in-out;
}
.card.shrink {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 280px;
    padding: 10px;
}
h3 { margin-bottom: 10px; color: #333; font-size: 16px; }
video {
    width: 100%;
    border-radius: 12px;
    border: 2px solid #ddd;
    margin-bottom: 10px;
}
.btn {
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}
.start { background-color: #28a745; color: white; }
.start:hover { background-color: #218838; }
.stop { background-color: #dc3545; color: white; }
.stop:hover { background-color: #c82333; }
.stop:disabled, .start:disabled { opacity: 0.6; cursor: not-allowed; }

#gameArea {
    width: 600px; height: 400px;
    border:2px solid #ccc;
    margin-left: 20px; position:relative;
    background:#fffbe6; border-radius:12px;
    overflow:hidden;
    display:flex; justify-content:center; align-items:center;
    font-size: 48px; font-weight:bold; color: #333;
}
#target {
    position:absolute; width:50px; height:50px;
    background:red; border-radius:50%; display:none;
}
#face {
    position:absolute; display:none;
    width:300px; height:300px;
    border-radius:12px;
}
#nameCall {
    display:none;
    position:absolute;
    font-size:48px;
    font-weight:bold;
    color:#333;
}
#loadingText {
    display:none;
    position:absolute;
    font-size:32px;
    font-weight:bold;
    color:#555;
    top:50%; left:50%;
    transform: translate(-50%, -50%);
}
</style>
</head>
<body>

<div class="card" id="recordCard">
    <h3>MERHABA: {{ isim }} {{ soyisim }}</h3>
    <video id="preview" autoplay playsinline muted></video>
    <div>
        <button id="startBtn" class="btn start">Kaydı Başlat</button>
        <button id="stopBtn" class="btn stop" disabled>Kaydı Durdur</button>
    </div>
</div>

<div id="gameArea">
    <div id="target"></div>
    <img id="face" src="" alt="face">
    <div id="nameCall">Merhaba {{ isim }}!</div>
    <div id="loadingText">Yükleniyor, lütfen bekleyin...</div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
const video = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const card = document.getElementById('recordCard');
const gameArea = document.getElementById('gameArea');
const target = document.getElementById('target');
const face = document.getElementById('face');
const nameCall = document.getElementById('nameCall');
const loadingText = document.getElementById('loadingText');

navigator.mediaDevices.getUserMedia({ video: true, audio: false })
.then(stream => {
    video.srcObject = stream;
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
        loadingText.style.display = 'block';
        const blob = new Blob(recordedChunks, {type:'video/webm'});
        recordedChunks = [];
        const formData = new FormData();
        formData.append('video', blob, '{{ isim }}_{{ soyisim }}.webm');
        formData.append('isim', '{{ isim }}');
        formData.append('soyisim', '{{ soyisim }}');

        fetch('/upload', { method:'POST', body:formData })
        .then(resp => {
            loadingText.style.display = 'none';
            if(resp.ok) alert("Video başarıyla yüklendi!");
            else alert("Hata oluştu.");
        });

        card.classList.remove('shrink');
        clearAllIntervals();
    };
})
.catch(err => alert("Kamera açılamadı: " + err));

startBtn.onclick = () => {
    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    card.classList.add('shrink');
    startSequentialGames();
};

stopBtn.onclick = () => {
    if(mediaRecorder.state !== "inactive") mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    clearAllIntervals();
};

let intervals = [];
let timeouts = [];

function clearAllIntervals(){
    intervals.forEach(i=>clearInterval(i));
    intervals = [];
    timeouts.forEach(t=>clearTimeout(t));
    timeouts = [];
    target.style.display='none';
    face.style.display='none';
    nameCall.style.display='none';
}

// Nokta oyunu
function randomTarget() {
    const x = Math.random()*(gameArea.clientWidth-50);
    const y = Math.random()*(gameArea.clientHeight-50);
    target.style.left = x+'px';
    target.style.top = y+'px';
    target.style.display='block';
    const audio = new Audio('/static/pop.mp3'); 
    audio.play();
}

// Mutlu/Üzgün
function showFace(emotion) {
    face.src = '/static/'+emotion;
    face.style.left = '150px';
    face.style.top = '50px';
    face.style.display='block';
    const audio = new Audio('/static/sound.mp3'); 
    audio.play();
}

// İsme seslenme
function showNameCall(){
    nameCall.style.display='block';
    const msg = new SpeechSynthesisUtterance("Merhaba {{ isim }}!");
    window.speechSynthesis.speak(msg);
}

// Oyunları sırayla başlat
function startSequentialGames(){
    clearAllIntervals();
    let step=0;

    function nextStep(){
        step++;
        if(step==1){
            // Nokta oyunu 12 saniye
            intervals.push(setInterval(randomTarget, 1000));
            timeouts.push(setTimeout(()=>{
                clearAllIntervals();
                nextStep();
            },12000));
        } else if(step==2){
            // İsme seslenme (rastgele bir anda)
            timeouts.push(setTimeout(()=>{
                showNameCall();
                timeouts.push(setTimeout(()=>{
                    nameCall.style.display='none';
                    nextStep();
                }, 5000));
            }, 1000 + Math.random()*5000));
        } else if(step==3){
            // Mutlu/Üzgün sırayla
            let emotions=['happy.png','sad.png'];
            let delay=0;
            emotions.forEach(em=>{
                timeouts.push(setTimeout(()=>{
                    showFace(em);
                    timeouts.push(setTimeout(()=>{
                        face.style.display='none';
                        if(em===emotions[emotions.length-1]){
                            if(mediaRecorder.state!=="inactive") mediaRecorder.stop();
                        }
                    }, 5000));
                }, delay));
                delay+=6000;
            });
        }
    }

    nextStep();
}
</script>
</body>
</html>
